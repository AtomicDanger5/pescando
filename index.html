<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mappa di pesca</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #map { min-height: 100vh; }
    .topbar { position: absolute; left: 10px; top: 10px; z-index: 1000; background:white; padding:6px; border-radius:4px; box-shadow:0 1px 4px rgba(0,0,0,0.3); }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="topbar">
    <button id="refreshBtn">Aggiorna</button>
    <small id="status" style="margin-left:8px"></small>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // ========= CONFIG =========
    const GEOJSON_FILE = "data.geojson";  // Nome del file GeoJSON con i punti
    const START_CENTER = [41.9, 12.5];    // Centra la mappa sull’Italia
    const START_ZOOM = 6;
    // ==========================

    const map = L.map('map').setView(START_CENTER, START_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const statusEl = document.getElementById('status');
    let dataLayer = null;

    function esc(s){ return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }

    function createPopup(props){
      let species = esc(props['Species'] || '');
      let date = esc(props['Date'] || '');
      let notes = esc(props['Notes'] || '');
      let img = props['Image URL'] || '';
      let html = `<b>${species}</b>`;
      if(date) html += `<br>Data: ${date}`;
      if(notes) html += `<br>${notes}`;
      if(img) html += `<br><img src="${esc(img)}" alt="foto" style="max-width:240px;margin-top:6px">`;
      return html;
    }

    // ====== Icone personalizzate ======
    var spigolaIcon = L.icon({
        iconUrl: 'https://i.imgur.com/1K6sMNi.png', // esempio Spigola tonda
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20]
    });

    var orataIcon = L.icon({
        iconUrl: 'https://i.imgur.com/0Z1p9Zr.png', // esempio Orata tonda
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20]
    });

    // ====== Caricamento GeoJSON ======
    function loadData(){
      statusEl.textContent = "Caricamento...";
      fetch(GEOJSON_FILE)
        .then(res => res.json())
        .then(data => {
          if(dataLayer) map.removeLayer(dataLayer);
          dataLayer = L.geoJSON(data, {
            pointToLayer: function(feature, latlng) {
              let icon;
              if(feature.properties.Species === "Spigola") icon = spigolaIcon;
              else if(feature.properties.Species === "Orata") icon = orataIcon;
              else icon = spigolaIcon; // default
              return L.marker(latlng, {icon: icon});
            },
            onEachFeature: function(feature, layer){
              layer.bindPopup(createPopup(feature.properties));
            }
          }).addTo(map);
          statusEl.textContent = `Caricati ${data.features.length} punti`;
          if(data.features.length){
            const bounds = dataLayer.getBounds();
            if(bounds.isValid()) map.fitBounds(bounds.pad(0.2));
          }
        })
        .catch(err => {
          console.error(err);
          statusEl.textContent = "Errore caricamento GeoJSON";
        });
    }

    document.getElementById('refreshBtn').addEventListener('click', loadData);
    loadData();  // carica all'avvio
  </script>
</body>
</html>
